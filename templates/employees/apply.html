<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BMA | Apply</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="/static/styles/bookmark.css" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; }
    .card { transition: transform 0.3s ease, box-shadow 0.3s ease; }
    .card:hover { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); }
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    .file-drop:hover { border-color: #16a34a; background-color: #f0fdf4; }
    
    @keyframes fade-in-out {
      0%, 100% { opacity: 0; transform: translateY(20px); }
      10%, 90% { opacity: 1; transform: translateY(0); }
    }
    .toast { animation: fade-in-out 2.5s ease forwards; }
  </style>
</head>

<body class="bg-gray-100 flex flex-col min-h-screen">

  <!-- Top Navbar -->
  <header class="bg-white shadow-md sticky top-0 z-30">
    <div class="flex justify-between items-center px-4 py-3 sm:px-6">
      <div class="flex items-center space-x-3">
        <img src="/static/images/BMA-Logo-Approved-3.png" alt="Logo" class="w-12 h-12">
      </div>

      <!-- Desktop Nav -->
      <div class="hidden sm:flex items-center space-x-6 text-gray-600 font-medium">
        <a href="{{url_for('employeeCvGuidelines')}}" class="flex items-center space-x-1 hover:text-green-600 transition">
          <span class="material-icons text-lg">menu_book</span><span>CV Guide</span>
        </a>
        <a href="{{url_for('employeeBookmarks')}}" class="flex items-center space-x-1 hover:text-green-600 transition">
          <span class="material-icons text-lg">bookmark</span><span>Bookmarked Jobs</span>
        </a>
        <a href="{{url_for('employeeNotifications')}}" class="flex items-center space-x-1 hover:text-green-600 transition">
          <span class="material-icons text-lg">notifications</span><span>Notifications</span>
        </a>
        <div class="flex items-center space-x-3">
          <img data-profile-image class="w-10 h-10 rounded-full border-2 border-green-500">
          <a href="javascript:void(0)" onclick="logout()" class="flex items-center space-x-1 hover:text-red-500 transition">
            <span class="material-icons text-lg">logout</span><span>Logout</span>
          </a>
        </div>
      </div>

    <!-- Mobile Controls -->
    <div class="sm:hidden flex items-center space-x-2 relative">
      <!-- Dropdown Trigger Icon -->
      <button id="mobileDropdownBtn" class="focus:outline-none text-gray-600 hover:text-green-600 transition">
        <img data-profile-image class="w-10 h-10 rounded-full border-2 border-green-500">
      </button>

      <!-- Sidebar Menu Button -->
      <button id="menuBtn" class="focus:outline-none text-green-700 hover:text-green-600 transition">
        <span class="material-icons text-3xl">menu</span>
      </button>

      <!-- Dropdown Menu -->
      <div id="mobileDropdown" class="hidden absolute right-0 top-full mt-2 w-48 bg-white border rounded-lg shadow-lg z-50">
        <a href="{{url_for('employeeCvGuidelines')}}" class="flex items-center px-4 py-2 hover:bg-green-50 hover:text-green-600 transition">
          <span class="material-icons mr-2 text-green-600">menu_book</span> CV Guide
        </a>
        <a href="{{url_for('employeeBookmarks')}}" class="flex items-center px-4 py-2 hover:bg-green-50 hover:text-green-600 transition">
          <span class="material-icons mr-2 text-green-600">bookmark</span> Bookmarked Jobs
        </a>
        <a href="{{url_for('employeeNotifications')}}" class="flex items-center px-4 py-2 hover:bg-green-50 hover:text-green-600 transition">
          <span class="material-icons mr-2 text-green-600">notifications</span> Notifications
        </a>
        <button onclick="logout()" class="w-full text-left flex items-center px-4 py-2 hover:bg-red-50 hover:text-red-500 transition">
          <span class="material-icons mr-2 text-red-500">logout</span> Logout
        </button>
      </div>

    </div>


    </div>
  </header>

  <!-- Sidebar -->
  <aside id="sidebar" class="fixed top-0 left-0 h-full w-64 bg-white shadow-md flex flex-col z-40 transform -translate-x-full sm:translate-x-0 transition-transform duration-300 ease-in-out">
    <div class="p-6 flex items-center space-x-3 border-b">
      <img src="/static/images/BMA-Logo-Approved-3.png" alt="Logo" class="w-20 h-20">
    </div>
    <nav class="flex-1 px-4 py-6 space-y-2 overflow-y-auto">
      <a href="{{url_for('employeeDashboard')}}" class="flex items-center px-4 py-2 rounded-lg font-semibold text-green-700 bg-green-50">
        <span class="material-icons mr-2 text-green-600">dashboard</span> Dashboard
      </a>
      <a href="{{url_for('employeeProfile')}}" class="flex items-center px-4 py-2 rounded-lg font-medium text-gray-700 hover:bg-green-50 hover:text-green-600 transition">
        <span class="material-icons mr-2 text-green-600">account_circle</span> Account
      </a>
      <a href="{{url_for('employeeApplications')}}" class="flex items-center px-4 py-2 rounded-lg font-medium text-gray-700 hover:bg-green-50 hover:text-green-600 transition">
        <span class="material-icons mr-2 text-green-600">description</span> Applications
      </a>
      <a href="{{url_for('employeeInterviews')}}" class="flex items-center px-4 py-2 rounded-lg font-medium text-gray-700 hover:bg-green-50 hover:text-green-600 transition">
        <span class="material-icons mr-2 text-green-600">event</span> Interviews
      </a>
      <a href="{{url_for('employeeOffers')}}" class="flex items-center px-4 py-2 rounded-lg font-medium text-gray-700 hover:bg-green-50 hover:text-green-600 transition">
        <span class="material-icons mr-2 text-green-600">how_to_reg</span> Offers
      </a>
      <a href="#" class="flex items-center px-4 py-2 rounded-lg font-medium text-gray-700 hover:bg-green-50 hover:text-green-600 transition">
        <span class="material-icons mr-2 text-green-600">event_available</span> Leave Management
      </a>
      <a href="#" class="flex items-center px-4 py-2 rounded-lg font-medium text-gray-700 hover:bg-green-50 hover:text-green-600 transition">
        <span class="material-icons mr-2 text-green-600">attach_money</span> Payslip Management
      </a>
      <a href="{{url_for('employeeAccountSettings')}}" class="flex items-center px-4 py-2 rounded-lg font-medium text-gray-700 hover:bg-green-50 hover:text-green-600 transition">
        <span class="material-icons mr-2 text-green-600">settings</span> Account Settings
      </a>
    </nav>
  </aside>

  <!-- Mobile Overlay -->
  <div id="overlay" class="fixed inset-0 bg-black bg-opacity-40 hidden z-30 sm:hidden"></div>

  <!-- Main Content -->
  <main class="flex-1 sm:ml-64 p-6 sm:p-10 transition-all duration-300">
    <div class="max-w-7xl mx-auto">
      <h2 class="text-2xl font-bold text-green-600 mb-6">Application</h2>
    </div>

    <!-- Progress Line -->
    <div class="relative mb-10">
      <div class="absolute top-1/2 left-0 w-full h-1 bg-gray-200 rounded-full transform -translate-y-1/2"></div>
      <div id="progressLine" class="absolute top-1/2 left-0 w-1/4 h-1 bg-gradient-to-r from-green-400 to-green-600 rounded-full transform -translate-y-1/2 transition-all duration-500"></div>
      <div class="flex justify-between relative z-10">
        <div id="indicator1" class="w-10 h-10 rounded-full bg-green-600 text-white flex items-center justify-center font-semibold shadow">✓</div>
        <div id="indicator2" class="w-10 h-10 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-semibold shadow">2</div>
        <div id="indicator3" class="w-10 h-10 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-semibold shadow">3</div>
        <div id="indicator4" class="w-10 h-10 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-semibold shadow">4</div>
      </div>
    </div>

    <!-- Multi-Step Form -->
  <form id="applyForm" class="space-y-8">

    <!-- STEP 1 -->
    <div id="step1" class="space-y-6">
      <div class="grid md:grid-cols-2 gap-6">
        <div class="card p-4 bg-white rounded-lg shadow">
          <label class="block text-gray-700 font-medium mb-2">Years Of Experience</label>
          <input type="number" name="experience" class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-green-500 outline-none" required>
        </div>
        <div class="card p-4 bg-white rounded-lg shadow">
          <label class="block text-gray-700 font-medium mb-2">Highest Level Of Education</label>
          <input type="text" name="qualification" class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-green-500 outline-none" required>
        </div>
      </div>
      <div class="grid md:grid-cols-2 gap-6">
        <div class="card p-4 bg-white rounded-lg shadow">
          <label class="block text-gray-700 font-medium mb-2">City / State</label>
          <input type="text" name="location" class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-green-500 outline-none">
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div class="card p-4 bg-white rounded-lg shadow">
            <label class="block text-gray-700 font-medium mb-2">Min Salary (R)</label>
            <input type="number" name="min_salary" class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-green-500 outline-none">
          </div>
          <div class="card p-4 bg-white rounded-lg shadow">
            <label class="block text-gray-700 font-medium mb-2">Max Salary (R)</label>
            <input type="number" name="max_salary" class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-green-500 outline-none">
          </div>
        </div>
      </div>
      <div class="flex justify-end">
        <button type="button" id="next1" class="bg-green-600 text-white px-8 py-2 rounded-lg hover:bg-green-700 transition shadow">Next</button>
      </div>
    </div>

    <!-- STEP 2 -->
    <div id="step2" class="hidden space-y-6">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">Technical Questions</h2>
      <div class="space-y-4" id="technicalQuestions"></div>
      <div class="flex justify-between">
        <button type="button" id="prev2" class="border border-gray-300 text-gray-700 px-8 py-2 rounded-lg hover:bg-gray-100 transition">Back</button>
        <button type="button" id="next2" class="bg-green-600 text-white px-8 py-2 rounded-lg hover:bg-green-700 transition shadow">Next</button>
      </div>
    </div>

    <!-- STEP 3 -->
    <div id="step3" class="hidden space-y-6">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">Supporting Documents</h2>
      <div class="card border-2 border-dashed border-gray-300 rounded-lg p-6 text-center file-drop">
        <input type="file" name="cv_document" id="resumeUpload" accept=".pdf,.doc,.docx" class="hidden">
        <p id="resumeText" class="text-gray-600">Click to upload your CV (PDF/DOC)</p>
      </div>
      <div class="flex justify-between">
        <button type="button" id="prev3" class="border border-gray-300 text-gray-700 px-8 py-2 rounded-lg hover:bg-gray-100 transition">Back</button>
        <button type="button" id="next3" class="bg-green-600 text-white px-8 py-2 rounded-lg hover:bg-green-700 transition shadow">Next</button>
      </div>
    </div>

    <!-- STEP 4 -->
    <div id="step4" class="hidden space-y-6">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">Review & Submit</h2>
      <div id="reviewSection" class="p-4 bg-white rounded-lg shadow space-y-2"></div>
      <div class="flex justify-between">
        <button type="button" id="prev4" class="border border-gray-300 text-gray-700 px-8 py-2 rounded-lg hover:bg-gray-100 transition">Back</button>
        <button type="submit" class="bg-green-600 text-white px-8 py-2 rounded-lg hover:bg-green-700 transition shadow">Submit</button>
      </div>
    </div>

  </form>
  </main>

<div id="toast" class="toast"></div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="/static/js/login.js"></script>
<script>
  // Sidebar toggle
  const menuBtn = document.getElementById('menuBtn');
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('overlay');

  menuBtn.onclick = () => {
    sidebar.classList.toggle('-translate-x-full');
    overlay.classList.toggle('hidden');
  };
  overlay.onclick = () => {
    sidebar.classList.add('-translate-x-full');
    overlay.classList.add('hidden');
  };
</script>

<script>
const jobId = "{{job_id}}";
const applicantId = sessionStorage.getItem("applicant_id");

// Sidebar & File
const resumeUpload = document.getElementById('resumeUpload');
const resumeText = document.getElementById('resumeText');
resumeText.parentElement.onclick = () => resumeUpload.click();
resumeUpload.onchange = () => {
  const fileName = resumeUpload.files[0]?.name || 'Click to upload your CV (PDF/DOC)';
  resumeText.textContent = fileName;
};

// Toast
function showToast(msg, success = true) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.background = success ? '#16a34a' : '#dc2626';
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

// Multi-step
const steps = ['step1', 'step2', 'step3', 'step4'];
let currentStep = 0;

function showStep() {
  steps.forEach((s, i) => document.getElementById(s).classList.toggle('hidden', i !== currentStep));
  document.getElementById('progressLine').style.width = (currentStep / (steps.length - 1) * 100) + '%';
  steps.forEach((_, i) => {
    const ind = document.getElementById(`indicator${i + 1}`);
    if (i <= currentStep) {
      ind.classList.remove('bg-gray-300', 'text-gray-600');
      ind.classList.add('bg-green-600', 'text-white');
    } else {
      ind.classList.remove('bg-green-600', 'text-white');
      ind.classList.add('bg-gray-300', 'text-gray-600');
    }
  });
}
document.getElementById('next1').onclick = () => { currentStep = 1; showStep(); };
document.getElementById('next2').onclick = () => { currentStep = 2; showStep(); };
document.getElementById('next3').onclick = () => { populateReview(); currentStep = 3; showStep(); };
document.getElementById('prev2').onclick = () => { currentStep = 0; showStep(); };
document.getElementById('prev3').onclick = () => { currentStep = 1; showStep(); };
document.getElementById('prev4').onclick = () => { currentStep = 2; showStep(); };
showStep();

// Fetch Job & Populate Questions
async function fetchJob() {
  try {
    const res = await fetch(`https://jellyfish-app-z83s2.ondigitalocean.app/api/candidate/viewPost/${jobId}`);
    const data = await res.json();
    const techContainer = document.getElementById('technicalQuestions');

    if (!data.questions || data.questions.length === 0) {
      techContainer.innerHTML = `<div class="text-gray-500 italic">No technical questions for this job.</div>`;
      return;
    }

    data.questions.forEach((q, i) => {
      const div = document.createElement('div');
      div.className = 'card p-4 bg-white rounded-lg shadow';
      div.innerHTML = `
        <label class="block text-gray-700 font-medium mb-2">${q.question}</label>
        <textarea name="question_${q.question_id}" 
          class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-green-500 outline-none" 
          rows="3"></textarea>`;
      techContainer.appendChild(div);
    });
  } catch (e) {
    console.error(e);
    showToast('Failed to load job data', false);
  }
}
fetchJob();

// Populate Review
function populateReview() {
  const form = new FormData(document.getElementById('applyForm'));
  const review = document.getElementById('reviewSection');
  review.innerHTML = ''; // Clear previous review

  const personalInfo = [];
  const salaryInfo = [];
  const questions = [];
  let cvFile = '';

  form.forEach((v, k) => {
    if (k === 'cv_document') {
      cvFile = v.name || 'Not uploaded';
    } else if (k.startsWith('question_')) {
      questions.push({ question: k.replace('question_', 'Question '), answer: v });
    } else if (['min_salary', 'max_salary'].includes(k)) {
      salaryInfo.push({ label: k.replace('_', ' '), value: v });
    } else {
      personalInfo.push({ label: k.replace('_', ' '), value: v });
    }
  });

  // Build beautiful review layout
  review.innerHTML = `
    <div class="space-y-6">
      <div class="p-5 bg-white rounded-xl shadow border border-gray-200">
        <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
          <span class="material-icons text-green-600">person</span> Personal Information
        </h3>
        <div class="grid md:grid-cols-2 gap-3 text-sm text-gray-700">
          ${personalInfo.map(i => `
            <div>
              <p class="font-medium text-gray-900">${i.label.replace(/_/g, ' ')}</p>
              <p class="text-gray-600">${i.value || '—'}</p>
            </div>
          `).join('')}
        </div>
      </div>

      <div class="p-5 bg-white rounded-xl shadow border border-gray-200">
        <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
          <span class="material-icons text-green-600">attach_money</span> Salary Expectation
        </h3>
        <div class="grid md:grid-cols-2 gap-3 text-sm text-gray-700">
          ${salaryInfo.map(s => `
            <div>
              <p class="font-medium text-gray-900">${s.label}</p>
              <p class="text-gray-600">R${Number(s.value).toLocaleString()}</p>
            </div>
          `).join('')}
        </div>
      </div>

      <div class="p-5 bg-white rounded-xl shadow border border-gray-200">
        <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
          <span class="material-icons text-green-600">quiz</span> Technical Questions
        </h3>
        <div class="space-y-4 text-sm text-gray-700">
          ${questions.length > 0 
            ? questions.map((q, i) => `
              <div class="border-l-4 border-green-500 pl-3">
                <p class="font-medium text-gray-900">Q${i + 1}:</p>
                <p class="italic text-gray-700">${q.answer || 'No answer provided'}</p>
              </div>
            `).join('')
            : `<p class="text-gray-500 italic">No technical questions provided.</p>`}
        </div>
      </div>

      <div class="p-5 bg-white rounded-xl shadow border border-gray-200">
        <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
          <span class="material-icons text-green-600">description</span> CV / Resume
        </h3>
        <p class="text-sm text-gray-700">${cvFile}</p>
      </div>
    </div>
  `;
}

// Helper: safely parse float
const parseFloatSafe = (val) => (val ? parseFloat(val) : 0);

// Submit
document.getElementById('applyForm').onsubmit = async (e) => {
  e.preventDefault();
  const form = new FormData(document.getElementById('applyForm'));

  const jobId = "{{ job_id }}";
  const applicantId = sessionStorage.getItem("applicant_id");

  // Build FormData for multipart/form-data
  const formData = new FormData();
  formData.append("cv_document", form.get("cv_document"));

  // Build query params
  const questions = [];
  form.forEach((v, k) => {
    if (k.startsWith("question_")) questions.push(v);
  });

  const params = new URLSearchParams({
    job_id: jobId,
    applicant_id: applicantId,
    experience: form.get("experience"),
    location: form.get("location"),
    qualification: form.get("qualification"),
    min_salary: form.get("min_salary"),
    max_salary: form.get("max_salary"),
  });

  // Append each question
  questions.forEach(q => params.append("questions", q));

  try {
    const res = await fetch(
      `https://jellyfish-app-z83s2.ondigitalocean.app/api/candidate/apply?${params.toString()}`,
      {
        method: "POST",
        body: formData, // multipart form
      }
    );

    const data = await res.json();
    if (res.ok) {
      Swal.fire({
        icon: "success",
        title: "Success!",
        text: data.message || "Application submitted successfully",
        confirmButtonColor: "#16a34a",
      });
    } else {
      console.error("Server Response:", data);
      Swal.fire({
        icon: "error",
        title: "Submission Failed",
        text: data.message || "Failed to submit application",
        confirmButtonColor: "#dc2626",
      });
    }
    } catch (e) {
      console.error("Error:", e);
      Swal.fire({
        icon: "error",
        title: "Network Error",
        text: "Please try again.",
        confirmButtonColor: "#dc2626",
      });
    }
};
</script>

<script src="/static/js/data_grabber.js"></script>

<script>
  const dropdownBtn = document.getElementById('mobileDropdownBtn');
  const dropdownMenu = document.getElementById('mobileDropdown');

  dropdownBtn.addEventListener('click', () => {
    dropdownMenu.classList.toggle('hidden');
  });

  document.addEventListener('click', (e) => {
    if (!dropdownMenu.contains(e.target) && !dropdownBtn.contains(e.target)) {
      dropdownMenu.classList.add('hidden');
    }
  });
</script>

</body>
</html>